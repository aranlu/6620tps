#define N 576
#include <string.h>
#include <stdio.h>

#define D 8
#define CE 8 /*NOTA: esto es solo un ejemplo para un tamano de linea de 64 bytes. Esta constante se modifica al instalar el programa y se adapta a 
cada arquitectura */


/*obtiene el blocking factor B */
int calcularB(int distancia){


	return (CE*distancia);

}

int min(int a,int b)
{
	if (a<b) 
		return(a);
	else
		return(b);	
}


/* ejecucion del programa*/

void ejecutar(int pad,int B, int distancia){

double a[N][N],pad1[pad],b[N][N],pad2[pad],c[N][N];
int i0,j0,k0,i,j,k;
	for (i0=0;i0<N;i0+=B)
		for (j0=0;j0<N;j0+=B)
			for (k0=0;k0<N;k0+=B){			
				/* PROLOGO*/

				/* proceso la primera linea*/
//				for (k=k0; k<=min(k0+B-1,(N-1)); k+=8)
				for (k=k0; k<=min(k0+B-1,(N-1)); k+=CE)
					__builtin_prefetch(&a[i0][k]);

				
				/* proceso toda la matriz a menos la ultima fila */

				for (i=i0;i<=min(i0+B-1,(N-1))-1;i++)
					for (k=k0;k<=min(k0+B-1,(N-1));k+=CE){

						__builtin_prefetch(&a[i+1][k]);
						for (j=j0;j<=min(j0+B-1,(N-1));j++){

						/* NOTA: esto es un ejemplo de codigo para una computadora donde entran 8 doubles en una linea. 
						   El desarrollo del lazo varia de acuerdo a la computadora donde se instala el programa, para
						   contamplar la cantidad de doubles que entran en una linea*/

						c[i][j]+=a[i][k+0]*b[k+0][j];
						c[i][j]+=a[i][k+1]*b[k+1][j];
						c[i][j]+=a[i][k+2]*b[k+2][j];
						c[i][j]+=a[i][k+3]*b[k+3][j];
						c[i][j]+=a[i][k+4]*b[k+4][j];
						c[i][j]+=a[i][k+5]*b[k+5][j];
						c[i][j]+=a[i][k+6]*b[k+6][j];
						c[i][j]+=a[i][k+7]*b[k+7][j];
						/*EXPANSION*/
							



						}
					}	


				/* EPILOGO*/
				/*proceso la \'ultima l\'iInea*/
				for (i=min(i0+B-1,(N-1))-1;i<=min(i0+B-1,(N-1));i++)
					for (k=k0;k<=min(k0+B-1,(N-1));k++)
						for (j=j0;j<=min(j0+B-1,(N-1));j++)
							c[i][j]+=a[i][k]*b[k][j];



			}




}


int main(int argc, char** argv)
{

int m,pad,B;
/*obtengo el tama\~no de la l\'inea*/
m=atoi(argv[1]);

/* calculo el pad, m\'ultiplo del tama\~no de la l\'inea*/
pad=m*2;

/*obtengo el blocking factor*/
B=calcularB(D);

ejecutar(pad,B,D);



return(0);


